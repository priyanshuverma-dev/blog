<!doctype html><html lang=en><head><meta property="og:image" content="https://media2.dev.to/dynamic/image/width=1000,height=500,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fk4reqgihadliptee85k9.png"><meta name=twitter:image content="https://media2.dev.to/dynamic/image/width=1000,height=500,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fk4reqgihadliptee85k9.png"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="My Writings - Priyanshu Verma"><meta property="og:url" content="https://priyanshuverma-dev.github.io/blogs/yes-its-easy-to-build-a-fluvio-connector-in-rust./"><meta property="og:title" content="Yes, It's easy to build a Fluvio connector in Rust."><meta property="og:description" content="In today’s fast-paced world, real-time data is no longer a luxury—it’s a necessity. Whether you&rsquo;re monitoring live stock prices, analyzing social media trends, or syncing spreadsheets for instant insights, having data at your fingertips can make all the difference. That’s where Fluvio comes in, a platform designed to streamline your data journey by offering a powerful, yet easy-to-use, infrastructure for building and managing data pipelines.
But here’s the real magic of Fluvio: It gives you the tools to not only move data between systems but also build your very own custom connectors! Imagine you’re working with Google Sheets, and you want your data to flow seamlessly from a Fluvio topic into a spreadsheet in real-time. Manually exporting data sounds tedious, right? What if you could build an outbound connector that does all this for you automatically?
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Yes, It's easy to build a Fluvio connector in Rust."><meta name=twitter:description content="In today’s fast-paced world, real-time data is no longer a luxury—it’s a necessity. Whether you&rsquo;re monitoring live stock prices, analyzing social media trends, or syncing spreadsheets for instant insights, having data at your fingertips can make all the difference. That’s where Fluvio comes in, a platform designed to streamline your data journey by offering a powerful, yet easy-to-use, infrastructure for building and managing data pipelines.
But here’s the real magic of Fluvio: It gives you the tools to not only move data between systems but also build your very own custom connectors! Imagine you’re working with Google Sheets, and you want your data to flow seamlessly from a Fluvio topic into a spreadsheet in real-time. Manually exporting data sounds tedious, right? What if you could build an outbound connector that does all this for you automatically?
"><meta name=description content="In today’s fast-paced world, real-time data is no longer a luxury—it’s a necessity. Whether you&rsquo;re monitoring live stock prices, analyzing social media trends, or syncing spreadsheets for instant insights, having data at your fingertips can make all the difference. That’s where Fluvio comes in, a platform designed to streamline your data journey by offering a powerful, yet easy-to-use, infrastructure for building and managing data pipelines.
But here’s the real magic of Fluvio: It gives you the tools to not only move data between systems but also build your very own custom connectors! Imagine you’re working with Google Sheets, and you want your data to flow seamlessly from a Fluvio topic into a spreadsheet in real-time. Manually exporting data sounds tedious, right? What if you could build an outbound connector that does all this for you automatically?
"><title>Yes, It's easy to build a Fluvio connector in Rust. | My Writings - Priyanshu Verma</title>
<link rel=canonical href=https://priyanshuverma-dev.github.io/blogs/yes-its-easy-to-build-a-fluvio-connector-in-rust./><link rel=icon type=image/png href=/blogs/favicon.ico><link rel=stylesheet href=/blogs/bundle.min.css></head><body><div id=body-wrapper><div id=left-wrapper></div><div id=center-wrapper><div id=header><div class="main-menu pure-menu pure-menu-horizontal"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://priyanshuverma-dev.github.io/>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=/blogs/>Blog</a></li><li class=pure-menu-item><a class=pure-menu-link href=/blogs/tags/>Tags</a></li></ul><div class=translation-menu></div></div></div><div id=main><div class=post-title><h1>Yes, It's easy to build a Fluvio connector in Rust.</h1></div><div class=post-meta><span>2024-09-08</span>
&nbsp;
<a class=post-tag href=/blogs/tags/rust/>Rust</a>
&nbsp;
<a class=post-tag href=/blogs/tags/fluvio/>Fluvio</a>
&nbsp;
<a class=post-tag href=/blogs/tags/buildinpublic/>Buildinpublic</a>
&nbsp;
<a class=post-tag href=/blogs/tags/opensource/>Opensource</a></div><div class=post-content><p>In today’s fast-paced world, real-time data is no longer a luxury—it’s a necessity. Whether you&rsquo;re monitoring live stock prices, analyzing social media trends, or syncing spreadsheets for instant insights, having data at your fingertips can make all the difference. That’s where <strong><a href=https://www.fluvio.io>Fluvio</a></strong> comes in, a platform designed to streamline your data journey by offering a powerful, yet easy-to-use, infrastructure for building and managing data pipelines.</p><p><strong>But here’s the real magic of Fluvio:</strong> It gives you the tools to not only move data between systems but also build your very own custom connectors! Imagine you’re working with Google Sheets, and you want your data to flow seamlessly from a Fluvio topic into a spreadsheet in real-time. Manually exporting data sounds tedious, right? What if you could build an outbound connector that does all this for you automatically?</p><p><strong>Sounds fun? It is!</strong> In this guide, we’ll walk through the process of building your own Google Sheets outbound connector. This isn’t just another tech tutorial—by the end of this, you’ll have a functional connector and a deeper understanding of how Fluvio can integrate with just about anything.</p><h3 id=why-build-a-connector>Why Build a Connector?</h3><p>If you’ve ever dealt with the challenge of moving data between systems, you know how time-consuming and prone to error it can be. Fluvio’s connectors are built to make this painless. You can import data with inbound connectors or export it with outbound connectors, depending on your needs. And the beauty is that both work in a similar way—the only difference is which direction your data is flowing in relation to a Fluvio topic.</p><p><strong>Imagine the possibilities:</strong></p><ul><li>Automatically stream real-time data from Fluvio to Google Sheets for analysis or reporting.</li><li>Set up an outbound connector to sync Fluvio data back into tools like Google Sheets for easy collaboration.</li><li>Use Fluvio as a central hub for all your real-time data needs, and effortlessly extend it with your own connectors!</li></ul><h3 id=lets-dive-in>Let’s Dive In</h3><p>We’ll use Google Sheets as our example, but the principles you’ll learn can apply to virtually any data destination. Whether you want to push data to a cloud service, a database, or even a custom application, Fluvio connectors can handle it. And once you get the hang of it, the possibilities are endless.</p><p>In the next sections, we’ll cover how to set up a Google Sheets outbound connector, configure it for your specific needs, and show how to stream data directly from a Fluvio topic to your spreadsheet. It’s a fun way to get started with Fluvio and unleash your creativity as a data engineer.</p><p><strong>Ready to get your hands dirty and build something awesome?</strong> Let’s jump right in and start connecting your data with the world of real-time streaming!</p><blockquote><p>For best developer experience use WSL or linux I am assuming that you are working on a linux machine.</p></blockquote><h3 id=setup-environment-to-build-connector>Setup Environment to build connector</h3><ul><li>Install Rust on your machine</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --proto <span style=color:#e6db74>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh
</span></span></code></pre></div><p>If you are facing any issue <a href=https://www.rust-lang.org/tools/install>Visit Rust Guide</a>.</p><ul><li>Add rust musl toolchain</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rustup target add x86_64-unknown-linux-musl
</span></span></code></pre></div><ul><li>Install Fluvio cli
We need to install fluvio cli for testing and generating connector project.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsS https://hub.infinyon.cloud/install/install.sh | bash
</span></span></code></pre></div><p>As part of the initial setup, <code>fvm</code> will also install the Fluvio CLI available in the stable channel as of the moment of installation.</p><p>Fluvio is stored in <code>$HOME/.fluvio</code>, with the executable binaries stored in <code>$HOME/.fluvio/bin</code>. Visit offical <a href=https://www.fluvio.io/docs/fluvio/quickstart>fluvio guide</a></p><ul><li>Generate a connector template project with cli
I am following fluvio&rsquo;s <a href=https://www.fluvio.io/docs/connectors/developers/generate>connector docs</a>.</li></ul><p>To generate project run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cdk generate
</span></span><span style=display:flex><span>🤷   Project Name: my-connector
</span></span><span style=display:flex><span>🤷   Please set a group name: acme
</span></span><span style=display:flex><span>🤷   Which type of Connector would you like <span style=color:#f92672>[</span>source/sink<span style=color:#f92672>]</span>? · sink
</span></span><span style=display:flex><span>🤷   Will your Connector be public? · false
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1/8<span style=color:#f92672>]</span>   Done: .gitignore
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>2/8<span style=color:#f92672>]</span>   Done: Cargo.toml
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>3/8<span style=color:#f92672>]</span>   Done: Connector.toml
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>4/8<span style=color:#f92672>]</span>   Done: README.md
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>5/8<span style=color:#f92672>]</span>   Done: sample-config.yaml
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>6/8<span style=color:#f92672>]</span>   Done: src/config.rs
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>7/8<span style=color:#f92672>]</span>   Done: src/main.rs
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>8/8<span style=color:#f92672>]</span>   Done: src
</span></span></code></pre></div><p>Chose connector type wisely I am selecting <code>sink</code>.
Now open this project in code editor like VScode.
You will find a file tree like this</p><pre tabindex=0><code>$ tree
.
├── Cargo.toml
├── Connector.toml
├── README.md
├── sample-config.yaml
└── src
    ├── config.rs
    └── main.rs
</code></pre><p>File you need to know are:</p><ul><li><code>Cargo.toml</code> - It is just like package.json for rust.</li><li><code>main.rs</code> - It is the entry point of the program.</li><li><code>config.rs</code> - It will have the connector parameters provided in sample-config.yaml.</li><li><code>sample-config.yaml</code> - It is a sample configuration to test our connector.</li></ul><h3 id=now-we-will-install-required-crate-for-the-project>Now we will install required crate for the project.</h3><p>You can use <code>cargo add [name]</code>
but for simplicity and consistency copy this dependency section to your <code>cargo.toml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>futures</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.3&#34;</span>, <span style=color:#a6e22e>default-features</span> = <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>serde</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;1.0&#34;</span>, <span style=color:#a6e22e>default-features</span> = <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>features</span> = [<span style=color:#e6db74>&#34;derive&#34;</span>] }
</span></span><span style=display:flex><span><span style=color:#a6e22e>serde_json</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;1&#34;</span>, <span style=color:#a6e22e>default-features</span> = <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>anyhow</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;1.0&#34;</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>async-std</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;1.8&#34;</span>, <span style=color:#a6e22e>default-features</span> = <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>features</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;attributes&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;tokio1&#34;</span>,
</span></span><span style=display:flex><span>] }
</span></span><span style=display:flex><span><span style=color:#a6e22e>async-trait</span> = { <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.1&#34;</span>, <span style=color:#a6e22e>default-features</span> = <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>fluvio</span> = { <span style=color:#a6e22e>git</span> = <span style=color:#e6db74>&#34;https://github.com/infinyon/fluvio&#34;</span>, <span style=color:#a6e22e>rev</span> = <span style=color:#e6db74>&#34;98cfc21314c93d4c2898edc9e2160f280622be21&#34;</span> }
</span></span><span style=display:flex><span><span style=color:#a6e22e>fluvio-connector-common</span> = { <span style=color:#a6e22e>git</span> = <span style=color:#e6db74>&#34;https://github.com/infinyon/fluvio&#34;</span>, <span style=color:#a6e22e>rev</span> = <span style=color:#e6db74>&#34;98cfc21314c93d4c2898edc9e2160f280622be21&#34;</span>, <span style=color:#a6e22e>features</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;derive&#34;</span>,
</span></span><span style=display:flex><span>] }
</span></span><span style=display:flex><span><span style=color:#a6e22e>humantime</span> = <span style=color:#e6db74>&#34;2.1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>google-sheets4</span> = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span></code></pre></div><p>Main package to highlight is <code>google-sheets4</code>. It will help us to connect google spreadsheet.</p><h2 id=lets-write-some-code>Let&rsquo;s write some code</h2><p>First thing is to setup <code>config</code> inside <code>config.rs</code> let&rsquo;s declare some variables for google sheets like <code>private_key</code>, <code>client_email</code> and <code>token_url</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> fluvio_connector_common::{connector, secret::SecretString};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[connector(config, name = </span><span style=color:#e6db74>&#34;sheet&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SheetConfig</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> google_private_key: <span style=color:#a6e22e>SecretString</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> google_client_email: <span style=color:#a6e22e>SecretString</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> google_token_url: <span style=color:#a6e22e>SecretString</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here thing to note is the <code>#[connector(config, name = "sheet")]</code> in this <code>name = 'sheet'</code> is the section in which you add these secrets you will understand it in next section.</p><h3 id=now-setup-sample-configyaml>Now setup <code>sample-config.yaml</code></h3><p>Here in this we will add secrets in this config file open this and add the required code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>0.1.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>meta</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.1.0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-sheet-connector-test-connector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>sheet-connector-sink</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>topic</span>: <span style=color:#ae81ff>test-sheet-connector-topic</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>secrets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GOOGLE_PRIVATE_KEY</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GOOGLE_CLIENT_EMAIL</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GOOGLE_TOKEN_URI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sheet</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>google_private_key</span>: <span style=color:#ae81ff>${{ secrets.GOOGLE_PRIVATE_KEY }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>google_client_email</span>: <span style=color:#ae81ff>${{ secrets.GOOGLE_CLIENT_EMAIL }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>google_token_url</span>: <span style=color:#ae81ff>${{ secrets.GOOGLE_TOKEN_URI }}</span>
</span></span></code></pre></div><p>This file is almost self-explanatory. In this Important is to not copy and paste this code snippet in <code>type</code> their should be you project connector name and see <code>sheet</code> we wrote this block by <code>sheet</code> name because we coded it in <code>config.rs</code> I tell you in previous section.</p><p>Create a <code>secrets.txt</code> file in root folder and include this following data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>GOOGLE_PRIVATE_KEY=&#34;-----BEGIN PRIVATE KEY-----private-key----END PRIVATE KEY-----\n&#34;
</span></span><span style=display:flex><span>GOOGLE_CLIENT_EMAIL=&#34;example.iam.gserviceaccount.com&#34;
</span></span><span style=display:flex><span>GOOGLE_TOKEN_URI=&#34;https://oauth2.googleapis.com/token&#34;
</span></span></code></pre></div><p>You will get these things from the <a href=https://console.cloud.google.com>Google Cloud Console</a>.</p><blockquote><p>How to get them steps are at last of the article.</p></blockquote><h3 id=now-code-a-sink-file>Now code a sink file</h3><p>Create a file <code>sink.rs</code> inside <code>src</code>
add this code inside this file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>crate</span>::{config::SheetConfig, Payload};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> async_trait::async_trait;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> fluvio::Offset;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> fluvio_connector_common::{LocalBoxSink, Result, Sink};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> google_sheets4::{
</span></span><span style=display:flex><span>    api::ValueRange,
</span></span><span style=display:flex><span>    hyper::{self, client::HttpConnector},
</span></span><span style=display:flex><span>    hyper_rustls::{self, HttpsConnector},
</span></span><span style=display:flex><span>    oauth2::{self, ServiceAccountKey},
</span></span><span style=display:flex><span>    Error, Sheets,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SheetsSink</span> {
</span></span><span style=display:flex><span>    secret: <span style=color:#a6e22e>oauth2</span>::ServiceAccountKey,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> SheetsSink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(config: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>SheetConfig</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Self<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> private_key <span style=color:#f92672>=</span> config.google_private_key.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> client_email <span style=color:#f92672>=</span> config.google_client_email.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> token_uri <span style=color:#f92672>=</span> config.google_token_url.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> secret: <span style=color:#a6e22e>oauth2</span>::ServiceAccountKey <span style=color:#f92672>=</span> ServiceAccountKey {
</span></span><span style=display:flex><span>            client_email,
</span></span><span style=display:flex><span>            private_key,
</span></span><span style=display:flex><span>            token_uri,
</span></span><span style=display:flex><span>            auth_provider_x509_cert_url: None,
</span></span><span style=display:flex><span>            auth_uri: None,
</span></span><span style=display:flex><span>            client_id: None,
</span></span><span style=display:flex><span>            client_x509_cert_url: None,
</span></span><span style=display:flex><span>            key_type: None,
</span></span><span style=display:flex><span>            private_key_id: None,
</span></span><span style=display:flex><span>            project_id: None,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(Self { secret })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[async_trait]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Sink<span style=color:#f92672>&lt;</span>Payload<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> SheetsSink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>connect</span>(self, _offset: Option<span style=color:#f92672>&lt;</span>Offset<span style=color:#f92672>&gt;</span>) -&gt; Result<span style=color:#f92672>&lt;</span>LocalBoxSink<span style=color:#f92672>&lt;</span>Payload<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> auth <span style=color:#f92672>=</span> oauth2::ServiceAccountAuthenticator::builder(self.secret)
</span></span><span style=display:flex><span>            .build()
</span></span><span style=display:flex><span>            .<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> hub <span style=color:#f92672>=</span> Sheets::new(
</span></span><span style=display:flex><span>            hyper::Client::builder().build(
</span></span><span style=display:flex><span>                hyper_rustls::HttpsConnectorBuilder::new()
</span></span><span style=display:flex><span>                    .with_native_roots()
</span></span><span style=display:flex><span>                    .unwrap()
</span></span><span style=display:flex><span>                    .https_or_http()
</span></span><span style=display:flex><span>                    .enable_http1()
</span></span><span style=display:flex><span>                    .build(),
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>            auth,
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> unfold <span style=color:#f92672>=</span> futures::sink::unfold(
</span></span><span style=display:flex><span>            hub,
</span></span><span style=display:flex><span>            <span style=color:#f92672>|</span>hub: <span style=color:#a6e22e>Sheets</span><span style=color:#f92672>&lt;</span>HttpsConnector<span style=color:#f92672>&lt;</span>HttpConnector<span style=color:#f92672>&gt;&gt;</span>, record: <span style=color:#a6e22e>Payload</span><span style=color:#f92672>|</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> req <span style=color:#f92672>=</span> ValueRange {
</span></span><span style=display:flex><span>                    values: Some(record.values),
</span></span><span style=display:flex><span>                    range: None,
</span></span><span style=display:flex><span>                    major_dimension: None,
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> hub
</span></span><span style=display:flex><span>                    .spreadsheets()
</span></span><span style=display:flex><span>                    .values_append(req, <span style=color:#f92672>&amp;</span>record.spreadsheet_id, <span style=color:#f92672>&amp;</span>record.range)
</span></span><span style=display:flex><span>                    .value_input_option(<span style=color:#e6db74>&#34;USER_ENTERED&#34;</span>)
</span></span><span style=display:flex><span>                    .insert_data_option(<span style=color:#e6db74>&#34;OVERWRITE&#34;</span>)
</span></span><span style=display:flex><span>                    .include_values_in_response(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>                    .doit()
</span></span><span style=display:flex><span>                    .<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>match</span> result {
</span></span><span style=display:flex><span>                    Err(e) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>match</span> e {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// The Error enum provides details about what exactly happened.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// You can also just use its `Debug`, `Display` or `Error` traits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        Error::HttpError(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Io(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::MissingAPIKey
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::MissingToken(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Cancelled
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::UploadSizeLimitExceeded(_, _)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Failure(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::BadRequest(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::FieldClash(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::JsonDecodeError(_, _) <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, e),
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    Ok(res) <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;Success: </span><span style=color:#e6db74>{:?}</span><span style=color:#e6db74>&#34;</span>, res.<span style=color:#ae81ff>0.</span>status()),
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                Ok::<span style=color:#f92672>&lt;</span>_, anyhow::Error<span style=color:#f92672>&gt;</span>(hub)
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        Ok(Box::pin(unfold))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Don&rsquo;t react it is very easy just understand the core function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SheetsSink</span> {
</span></span><span style=display:flex><span>    secret: <span style=color:#a6e22e>oauth2</span>::ServiceAccountKey,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Create a struct here it is <code>SheetsSink</code> inside which we store data on initial connector run. We are saving <code>ServiceAccountKey</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span><span style=color:#66d9ef>impl</span> SheetsSink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span>(<span style=color:#66d9ef>crate</span>) <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(config: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>SheetConfig</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Self<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> private_key <span style=color:#f92672>=</span> config.google_private_key.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> client_email <span style=color:#f92672>=</span> config.google_client_email.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> token_uri <span style=color:#f92672>=</span> config.google_token_url.resolve()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> secret: <span style=color:#a6e22e>oauth2</span>::ServiceAccountKey <span style=color:#f92672>=</span> ServiceAccountKey {
</span></span><span style=display:flex><span>            client_email,
</span></span><span style=display:flex><span>            private_key,
</span></span><span style=display:flex><span>            token_uri,
</span></span><span style=display:flex><span>            auth_provider_x509_cert_url: None,
</span></span><span style=display:flex><span>            auth_uri: None,
</span></span><span style=display:flex><span>            client_id: None,
</span></span><span style=display:flex><span>            client_x509_cert_url: None,
</span></span><span style=display:flex><span>            key_type: None,
</span></span><span style=display:flex><span>            private_key_id: None,
</span></span><span style=display:flex><span>            project_id: None,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(Self { secret })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In this code block we are getting config like <code>private_key</code> and others and creating a <code>ServiceAccountKey</code> and set it to <code>Self</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[async_trait]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Sink<span style=color:#f92672>&lt;</span>Payload<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> SheetsSink {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After that we are implementing <code>SheetsSink</code> for the native <code>Sink</code> provided by fluvio. It requires a generic type of the struct that has data which you want to save. Here we created one named <code>Playload</code> importing from <code>main.rs</code>. We will see in next section.</p><p>We will create a <code>async function</code> named <code>connect</code> inside which we created <code>auth</code> variable saving authentication thing for <code>google spreadsheet</code> and create a <code>hub</code> with that <code>auth</code> this part is required for the package <code>google_sheets4</code>. You can see their <a href=https://docs.rs/google-sheets4>docs</a> for more information.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span> <span style=color:#66d9ef>let</span> unfold <span style=color:#f92672>=</span> futures::sink::unfold(
</span></span><span style=display:flex><span>            hub,
</span></span><span style=display:flex><span>            <span style=color:#f92672>|</span>hub: <span style=color:#a6e22e>Sheets</span><span style=color:#f92672>&lt;</span>HttpsConnector<span style=color:#f92672>&lt;</span>HttpConnector<span style=color:#f92672>&gt;&gt;</span>, record: <span style=color:#a6e22e>Payload</span><span style=color:#f92672>|</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> req <span style=color:#f92672>=</span> ValueRange {
</span></span><span style=display:flex><span>                    values: Some(record.values),
</span></span><span style=display:flex><span>                    range: None,
</span></span><span style=display:flex><span>                    major_dimension: None,
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> result <span style=color:#f92672>=</span> hub
</span></span><span style=display:flex><span>                    .spreadsheets()
</span></span><span style=display:flex><span>                    .values_append(req, <span style=color:#f92672>&amp;</span>record.spreadsheet_id, <span style=color:#f92672>&amp;</span>record.range)
</span></span><span style=display:flex><span>                    .value_input_option(<span style=color:#e6db74>&#34;USER_ENTERED&#34;</span>)
</span></span><span style=display:flex><span>                    .insert_data_option(<span style=color:#e6db74>&#34;OVERWRITE&#34;</span>)
</span></span><span style=display:flex><span>                    .include_values_in_response(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>                    .doit()
</span></span><span style=display:flex><span>                    .<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>match</span> result {
</span></span><span style=display:flex><span>                    Err(e) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>match</span> e {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// The Error enum provides details about what exactly happened.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// You can also just use its `Debug`, `Display` or `Error` traits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        Error::HttpError(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Io(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::MissingAPIKey
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::MissingToken(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Cancelled
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::UploadSizeLimitExceeded(_, _)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::Failure(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::BadRequest(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::FieldClash(_)
</span></span><span style=display:flex><span>                        <span style=color:#f92672>|</span> Error::JsonDecodeError(_, _) <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, e),
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    Ok(res) <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;Success: </span><span style=color:#e6db74>{:?}</span><span style=color:#e6db74>&#34;</span>, res.<span style=color:#ae81ff>0.</span>status()),
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                Ok::<span style=color:#f92672>&lt;</span>_, anyhow::Error<span style=color:#f92672>&gt;</span>(hub)
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        Ok(Box::pin(unfold))
</span></span></code></pre></div><p>After that we have created a <code>unfold</code> variable which is resolving records that are sent on topic in <code>unfold</code> we are taking two parameter <code>hub</code> and a <code>payload</code>. At this I think you are familiar them both.
And executing a function to <code>append</code> the values in google spreadsheet and handling errors if there is any. then we are cleaning everything at the end with <code>Ok()</code>.</p><h3 id=its-time-to-touch-mainrs-entrypoint>It&rsquo;s time to touch <code>main.rs</code> entrypoint</h3><p>In this file we need to understand only couple of things first add this code inside it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> config;
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> sink;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> anyhow::anyhow;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> config::SheetConfig;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> futures::{SinkExt, StreamExt};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> fluvio_connector_common::{
</span></span><span style=display:flex><span>    connector,
</span></span><span style=display:flex><span>    consumer::ConsumerStream,
</span></span><span style=display:flex><span>    future::retry::ExponentialBackoff,
</span></span><span style=display:flex><span>    tracing::{error, trace, warn},
</span></span><span style=display:flex><span>    Result, Sink,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde::{Deserialize, Serialize};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> sink::SheetsSink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>BACKOFF_MIN</span>: <span style=color:#a6e22e>Duration</span> <span style=color:#f92672>=</span> Duration::from_secs(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>BACKOFF_MAX</span>: <span style=color:#a6e22e>Duration</span> <span style=color:#f92672>=</span> Duration::from_secs(<span style=color:#ae81ff>3600</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Data payload structure to be inserted into the Google Sheet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#[derive(Debug, Clone, Serialize, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Payload</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> range: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> values: Vec<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span>serde_json::Value<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> major_dimension: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> spreadsheet_id: String,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[connector(sink)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>start</span>(config: <span style=color:#a6e22e>SheetConfig</span>, <span style=color:#66d9ef>mut</span> stream: <span style=color:#a6e22e>impl</span> ConsumerStream) -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Starting sheet-connector sink connector with </span><span style=color:#e6db74>{config:?}</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> backoff <span style=color:#f92672>=</span> backoff_init()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> Some(wait) <span style=color:#f92672>=</span> backoff.next() <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// not currently possible, but if backoff strategy is changed later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// this could kick in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>let</span> msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Retry backoff exhausted&#34;</span>;
</span></span><span style=display:flex><span>            error!(msg);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Err(anyhow!(msg));
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> wait <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>BACKOFF_MAX</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// max retry set to 24hrs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            error!(<span style=color:#e6db74>&#34;Max retry reached&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> sink <span style=color:#f92672>=</span> SheetsSink::new(<span style=color:#f92672>&amp;</span>config)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> sink <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> sink.connect(None).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>            Ok(sink) <span style=color:#f92672>=&gt;</span> sink,
</span></span><span style=display:flex><span>            Err(err) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                warn!(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Error connecting to sink: </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>, reconnecting in {}.&#34;</span>,
</span></span><span style=display:flex><span>                    err,
</span></span><span style=display:flex><span>                    humantime::format_duration(wait)
</span></span><span style=display:flex><span>                );
</span></span><span style=display:flex><span>                async_std::task::sleep(wait).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>; <span style=color:#75715e>// loop and retry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#75715e>// reset the backoff on successful connect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        backoff <span style=color:#f92672>=</span> backoff_init()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>let</span> Some(item) <span style=color:#f92672>=</span> stream.next().<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> out: <span style=color:#a6e22e>std</span>::result::Result<span style=color:#f92672>&lt;</span>Payload, serde_json::Error<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                serde_json::from_slice(item<span style=color:#f92672>?</span>.as_ref());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>match</span> out {
</span></span><span style=display:flex><span>                Ok(payload) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                    trace!(<span style=color:#f92672>?</span>payload);
</span></span><span style=display:flex><span>                    sink.send(payload).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                Err(_) <span style=color:#f92672>=&gt;</span> error!(<span style=color:#e6db74>&#34;data parsing error. try again&#34;</span>),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>backoff_init</span>() -&gt; Result<span style=color:#f92672>&lt;</span>ExponentialBackoff<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> bmin: <span style=color:#66d9ef>u64</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>BACKOFF_MIN</span>.as_millis().try_into()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    Ok(ExponentialBackoff::from_millis(bmin).max_delay(<span style=color:#66d9ef>BACKOFF_MAX</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First thing is <code>Payload</code> struct</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Serialize, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Payload</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> range: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> values: Vec<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span>serde_json::Value<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> major_dimension: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> spreadsheet_id: String,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This struct contain important things like <code>values</code>, <code>range</code> and <code>spreadsheet_id</code> and everything is self explanatory.</p><p>Then we have a function <code>start</code> which is the entrypoint gives us <code>config</code> and <code>comsumer stream</code> inside this we are handling <code>retries</code> with <code>backoff</code> function on need to understand this for now it just optimize connector.</p><p>The main code block is this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span><span style=color:#66d9ef>let</span> sink <span style=color:#f92672>=</span> SheetsSink::new(<span style=color:#f92672>&amp;</span>config)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> sink <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> sink.connect(None).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>            Ok(sink) <span style=color:#f92672>=&gt;</span> sink,
</span></span><span style=display:flex><span>            Err(err) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                warn!(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Error connecting to sink: </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>, reconnecting in {}.&#34;</span>,
</span></span><span style=display:flex><span>                    err,
</span></span><span style=display:flex><span>                    humantime::format_duration(wait)
</span></span><span style=display:flex><span>                );
</span></span><span style=display:flex><span>                async_std::task::sleep(wait).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>; <span style=color:#75715e>// loop and retry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span><span style=color:#75715e>// reset the backoff on successful connect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        backoff <span style=color:#f92672>=</span> backoff_init()<span style=color:#f92672>?</span>;
</span></span></code></pre></div><p>In this we are connecting to our own <code>sink</code> that we created with config provided and handling error if their is any. After this resetting <code>backoff</code> after connection.</p><p>Then In last block below we are looping the stream in which we parsed <code>Payload</code> by <code>serde_json</code> and executing that with <code>sink.send(payload)</code>. Handling some errors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rs data-lang=rs><span style=display:flex><span> <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>let</span> Some(item) <span style=color:#f92672>=</span> stream.next().<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> out: <span style=color:#a6e22e>std</span>::result::Result<span style=color:#f92672>&lt;</span>Payload, serde_json::Error<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                serde_json::from_slice(item<span style=color:#f92672>?</span>.as_ref());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>match</span> out {
</span></span><span style=display:flex><span>                Ok(payload) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                    trace!(<span style=color:#f92672>?</span>payload);
</span></span><span style=display:flex><span>                    sink.send(payload).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                Err(_) <span style=color:#f92672>=&gt;</span> error!(<span style=color:#e6db74>&#34;data parsing error. try again&#34;</span>),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><h3 id=finally-build-connector-and-test>Finally build connector and test</h3><p>It&rsquo;s time to build the connector and test it.</p><ul><li>Build connector by this command
make sure running in root directory</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cdk build
</span></span></code></pre></div><blockquote><p>If facing any error then use this command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cdk build --target x86-64-unknown-linux-unknown
</span></span></code></pre></div><p>change <code>x86-64</code> with your system&rsquo;s architecture</p></blockquote><ul><li>Test it with <code>sample-config.yaml</code> and <code>secrets.txt</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> cdk test --config sample-config.yaml --secrets secrets.txt
</span></span></code></pre></div><ul><li>Run fluvio producer and produce some sample data and see it in google spreadsheet.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fluvio produce <span style=color:#f92672>[</span>topic-name<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>send sample data like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;range&#34;</span>: <span style=color:#e6db74>&#34;A1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;major_dimension&#34;</span>: <span style=color:#e6db74>&#34;ROWS&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;values&#34;</span>: [[<span style=color:#e6db74>&#34;A1 value&#34;</span>, <span style=color:#e6db74>&#34;A2 value&#34;</span>, <span style=color:#e6db74>&#34;A3 value&#34;</span>]],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;spreadsheet_id&#34;</span>: <span style=color:#e6db74>&#34;spreadsheet_id&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>replace spreadsheet_id with your owns.</p><p>If you face any permission error like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;code&#34;</span>: 403,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;The caller does not have permission&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;PERMISSION_DENIED&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>refer to this fix.</p><p>Add your <code>client_email</code> from google console in the spreadsheet&rsquo;s <code>editor</code> section or see <a href=https://stackoverflow.com/questions/38949318/google-sheets-api-returns-the-caller-does-not-have-permission-when-using-serve>Fix On StackOverflow</a></p><h3 id=get-service-account-keys>Get Service account keys</h3><ul><li>Go to <a href=https://console.cloud.google.com>Google Cloud Console</a>.</li><li>Create a new project or select existing project</li><li>Go to <code>Enable APIs and Services</code></li></ul><p><img src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/90rxiuu1ttcscyuk3vh2.png alt="Google Cloud Console - Enable APIs and Services"></p><ul><li>Click on <code>Library</code> and Search for <code>Google Sheets API</code> and enable it</li></ul><p><img src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jgbf93pnzd6v59lq3tzh.png alt="Google Cloud Console - Google Sheets API"></p><ul><li>Now go to <code>service account</code> to create one</li></ul><p><img src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xfiyu5x2izq0mq8nqeok.png alt="Google Cloud Console - service account"></p><p>&mldr;</p><p>Source Code: <a href=https://github.com/priyanshuverma-dev/sheet-connector>Github</a></p><p>&mldr;</p><p>This was it for this article hope you enjoyed building it.
My name is Priyanshu Verma and you are reading about fluvio connectors.</p><p>Thanks.</p></div></div><div id=footer><span class=post-meta>&copy; Priyanshu Verma &nbsp;2024
</span>&nbsp;
<a href=/blogs/sitemap.xml title=Sitemap target=_blank>Sitemap</a> &nbsp;
<a href=https://github.com/priyanshuverma-dev title=Github target=_blank>Github</a></div></div><div id=right-wrapper></div></div><script src=https://statstream.onrender.com/scripts/tracker data-nscript=afterInteractive></script></body></html>